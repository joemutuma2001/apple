{"version":3,"file":"inp.js","sources":["../../../src/metrics/inp.ts"],"sourcesContent":["import {\n  SEMANTIC_ATTRIBUTE_EXCLUSIVE_TIME,\n  SEMANTIC_ATTRIBUTE_SENTRY_MEASUREMENT_UNIT,\n  SEMANTIC_ATTRIBUTE_SENTRY_MEASUREMENT_VALUE,\n  getActiveSpan,\n  getClient,\n  getCurrentScope,\n  getRootSpan,\n  spanToJSON,\n  startInactiveSpan,\n} from '@sentry/core';\nimport type { Integration, SpanAttributes } from '@sentry/types';\nimport { browserPerformanceTimeOrigin, dropUndefinedKeys, htmlTreeAsString } from '@sentry/utils';\nimport { addInpInstrumentationHandler } from './instrument';\nimport { getBrowserPerformanceAPI, msToSec } from './utils';\n\n/**\n * Start tracking INP webvital events.\n */\nexport function startTrackingINP(): () => void {\n  const performance = getBrowserPerformanceAPI();\n  if (performance && browserPerformanceTimeOrigin) {\n    const inpCallback = _trackINP();\n\n    return (): void => {\n      inpCallback();\n    };\n  }\n\n  return () => undefined;\n}\n\nconst INP_ENTRY_MAP: Record<string, 'click' | 'hover' | 'drag' | 'press'> = {\n  click: 'click',\n  pointerdown: 'click',\n  pointerup: 'click',\n  mousedown: 'click',\n  mouseup: 'click',\n  touchstart: 'click',\n  touchend: 'click',\n  mouseover: 'hover',\n  mouseout: 'hover',\n  mouseenter: 'hover',\n  mouseleave: 'hover',\n  pointerover: 'hover',\n  pointerout: 'hover',\n  pointerenter: 'hover',\n  pointerleave: 'hover',\n  dragstart: 'drag',\n  dragend: 'drag',\n  drag: 'drag',\n  dragenter: 'drag',\n  dragleave: 'drag',\n  dragover: 'drag',\n  drop: 'drag',\n  keydown: 'press',\n  keyup: 'press',\n  keypress: 'press',\n  input: 'press',\n};\n\n/** Starts tracking the Interaction to Next Paint on the current page. */\nfunction _trackINP(): () => void {\n  return addInpInstrumentationHandler(({ metric }) => {\n    const client = getClient();\n    if (!client || metric.value == undefined) {\n      return;\n    }\n\n    const entry = metric.entries.find(entry => entry.duration === metric.value && INP_ENTRY_MAP[entry.name]);\n\n    if (!entry) {\n      return;\n    }\n\n    const interactionType = INP_ENTRY_MAP[entry.name];\n\n    const options = client.getOptions();\n    /** Build the INP span, create an envelope from the span, and then send the envelope */\n    const startTime = msToSec((browserPerformanceTimeOrigin as number) + entry.startTime);\n    const duration = msToSec(metric.value);\n    const scope = getCurrentScope();\n    const activeSpan = getActiveSpan();\n    const rootSpan = activeSpan ? getRootSpan(activeSpan) : undefined;\n\n    const routeName = rootSpan ? spanToJSON(rootSpan).description : undefined;\n    const user = scope.getUser();\n\n    // We need to get the replay, user, and activeTransaction from the current scope\n    // so that we can associate replay id, profile id, and a user display to the span\n    const replay = client.getIntegrationByName<Integration & { getReplayId: () => string }>('Replay');\n\n    const replayId = replay && replay.getReplayId();\n\n    const userDisplay = user !== undefined ? user.email || user.id || user.ip_address : undefined;\n    let profileId: string | undefined = undefined;\n    try {\n      // @ts-expect-error skip optional chaining to save bundle size with try catch\n      profileId = scope.getScopeData().contexts.profile.profile_id;\n    } catch {\n      // do nothing\n    }\n\n    const name = htmlTreeAsString(entry.target);\n    const attributes: SpanAttributes = dropUndefinedKeys({\n      release: options.release,\n      environment: options.environment,\n      transaction: routeName,\n      [SEMANTIC_ATTRIBUTE_EXCLUSIVE_TIME]: metric.value,\n      user: userDisplay || undefined,\n      profile_id: profileId || undefined,\n      replay_id: replayId || undefined,\n    });\n\n    const span = startInactiveSpan({\n      name,\n      op: `ui.interaction.${interactionType}`,\n      attributes,\n      startTime: startTime,\n      experimental: {\n        standalone: true,\n      },\n    });\n\n    span.addEvent('inp', {\n      [SEMANTIC_ATTRIBUTE_SENTRY_MEASUREMENT_UNIT]: 'millisecond',\n      [SEMANTIC_ATTRIBUTE_SENTRY_MEASUREMENT_VALUE]: metric.value,\n    });\n\n    span.end(startTime + duration);\n  });\n}\n"],"names":[],"mappings":"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"}